// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  admin
  farmer
}

enum RunStatus {
  idle
  running
  done
}

enum RunMode {
  auto
  manual
}

enum CommandStatus {
  queued
  sent
  executed
}

enum DeviceRole {
  owner
  viewer
}

model User {
  id            String         @id @default(uuid())
  fullName      String         @map("full_name")
  username      String         @unique
  email         String         @unique
  passwordHash  String         @map("password_hash")
  role          Role           @default(farmer)
  isActive      Boolean        @default(true) @map("is_active")
  createdAt     DateTime       @default(now()) @map("created_at")
  devices       Device[]
  deviceUsers   DeviceUser[]
  activities    DeviceActivity[]

  @@map("users")
}

model Device {
  id                String            @id @default(uuid())
  userId            String?           @map("user_id")
  name              String
  deviceCode        String            @unique @map("device_code")
  ownerCode         String?           @unique @map("owner_code")
  isOnline          Boolean           @default(false) @map("is_online")
  lastSeen          DateTime?         @map("last_seen")
  maxUsers          Int               @default(1) @map("max_users")
  createdAt         DateTime          @default(now()) @map("created_at")
  user              User?             @relation(fields: [userId], references: [id], onDelete: SetNull)
  settings          DeviceSettings?
  fermentationRuns  FermentationRun[]
  telemetry         Telemetry[]
  commands          DeviceCommand[]
  telemetryHistory  TelemetryHistory[]
  deviceUsers       DeviceUser[]
  activities        DeviceActivity[]

  @@map("devices")
}

model DeviceUser {
  id        String     @id @default(uuid())
  deviceId  String     @map("device_id")
  userId    String     @map("user_id")
  role      DeviceRole @default(viewer)
  joinedAt  DateTime   @default(now()) @map("joined_at")
  device    Device     @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([deviceId, userId])
  @@map("device_users")
}

model DeviceActivity {
  id        BigInt   @id @default(autoincrement())
  deviceId  String   @map("device_id")
  userId    String?  @map("user_id")
  action    String
  detail    Json?
  createdAt DateTime @default(now()) @map("created_at")
  device    Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("device_activities")
}

model DeviceSettings {
  deviceId         String   @id @map("device_id")
  targetPh         Decimal  @default(4.5) @map("target_ph") @db.Decimal(4, 2)
  autoDrainEnabled Boolean  @default(false) @map("auto_drain_enabled")
  maxHeight        Int      @default(50) @map("max_height")
  telegramChatId   String?  @map("telegram_chat_id")
  updatedAt        DateTime @default(now()) @updatedAt @map("updated_at")
  device           Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@map("device_settings")
}

model FermentationRun {
  id            String      @id @default(uuid())
  deviceId      String      @map("device_id")
  name          String?     @default("Fermentasi Baru")
  cassavaAmount Float?      @map("cassava_amount")
  status        RunStatus   @default(idle)
  mode          RunMode     @default(auto)
  startedAt     DateTime?   @map("started_at")
  endedAt       DateTime?   @map("ended_at")
  createdAt     DateTime    @default(now()) @map("created_at")
  device        Device      @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  telemetry     Telemetry[]

  @@map("fermentation_runs")
}

model Telemetry {
  id         BigInt           @id @default(autoincrement())
  deviceId   String           @map("device_id")
  runId      String?          @map("run_id")
  ph         Decimal          @db.Decimal(4, 2)
  tempC      Decimal          @map("temp_c") @db.Decimal(4, 1)
  waterLevel Int              @map("water_level")
  createdAt  DateTime         @default(now()) @map("created_at")
  device     Device           @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  run        FermentationRun? @relation(fields: [runId], references: [id], onDelete: SetNull)

  @@map("telemetry")
}

model DeviceCommand {
  id        BigInt        @id @default(autoincrement())
  deviceId  String        @map("device_id")
  command   String
  payload   Json?
  status    CommandStatus @default(queued)
  createdAt DateTime      @default(now()) @map("created_at")
  device    Device        @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@map("device_commands")
}

model TelemetryHistory {
  id              BigInt   @id @default(autoincrement())
  deviceId        String   @map("device_id")
  avgPh           Decimal  @map("avg_ph") @db.Decimal(4, 2)
  avgTempC        Decimal  @map("avg_temp_c") @db.Decimal(4, 1)
  avgWaterLevel   Decimal  @map("avg_water_level") @db.Decimal(5, 2)
  recordedAt      DateTime @default(now()) @map("recorded_at")
  device          Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@map("telemetry_history")
}

model MqttStatus {
  topic       String   @id
  message     String?  @db.Text
  lastUpdated DateTime @default(now()) @updatedAt @map("last_updated")

  @@map("mqtt_status")
}
